

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>dman.model.modelclasses &mdash; dman 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sg_gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sg_gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sg_gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> dman
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/misc/example0_common.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/cases/index.html">Case Studies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/patterns/index.html">Design Patterns</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/fundamentals/index.html">Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">Modules</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dman</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>dman.model.modelclasses</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for dman.model.modelclasses</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines Model Types, which are containers for storables.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">MutableMapping</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">MutableSequence</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">MISSING</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">is_dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">dataclass_transform</span>
<span class="kn">from</span> <span class="nn">dman.core</span> <span class="kn">import</span> <span class="n">log</span>

<span class="kn">from</span> <span class="nn">dman.utils.smartdataclasses</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">wrappedclass</span><span class="p">,</span>
    <span class="n">wrapfield</span><span class="p">,</span>
    <span class="n">is_wrapfield</span><span class="p">,</span>
    <span class="n">get_descriptor</span><span class="p">,</span>
    <span class="n">configclass</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">dman.core.storables</span> <span class="kn">import</span> <span class="n">is_storable</span><span class="p">,</span> <span class="n">storable</span>
<span class="kn">from</span> <span class="nn">dman.model.record</span> <span class="kn">import</span> <span class="n">Record</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">is_removable</span>
<span class="kn">from</span> <span class="nn">dman.core.serializables</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SERIALIZE</span><span class="p">,</span>
    <span class="n">DESERIALIZE</span><span class="p">,</span>
    <span class="n">NO_SERIALIZE</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">dman.core.serializables</span> <span class="kn">import</span> <span class="n">BaseContext</span><span class="p">,</span> <span class="n">serialize</span><span class="p">,</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">serializable</span>
<span class="kn">from</span> <span class="nn">dman.core.path</span> <span class="kn">import</span> <span class="n">Target</span><span class="p">,</span> <span class="n">AUTO</span>


<span class="n">STO_FIELD</span> <span class="o">=</span> <span class="s2">&quot;_record__fields&quot;</span>
<span class="n">SER_FIELD</span> <span class="o">=</span> <span class="s2">&quot;_serial__fields&quot;</span>
<span class="n">RECORD_FIELDS</span> <span class="o">=</span> <span class="s2">&quot;__record__&quot;</span>
<span class="n">UNUSED_FIELDS</span> <span class="o">=</span> <span class="s2">&quot;__unused__&quot;</span>
<span class="n">MODELCLASS</span> <span class="o">=</span> <span class="s2">&quot;__modelclass__&quot;</span>
<span class="n">RECORD_PRE</span> <span class="o">=</span> <span class="s2">&quot;_record_field__&quot;</span>


<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.Config">[docs]</a><span class="nd">@configclass</span>
<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for model types.</span>

<span class="sd">        This class has a global instance that can be accessed as follows:</span>

<span class="sd">        &gt;&gt;&gt; dman.model.modelclasses.config.auto_clean = True</span>
<span class="sd">        &gt;&gt;&gt; dman.params.model.auto_clean = True  # equivalent</span>

<span class="sd">    Args:</span>
<span class="sd">        auto_clean (bool, optional): Automatically clean files associated with items that were removed from the container.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">auto_clean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></div>
<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_record_key</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RECORD_FIELDS</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="get_record"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.get_record">[docs]</a><span class="k">def</span> <span class="nf">get_record</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">MISSING</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the record for a field in a modelclass.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: The modelclass</span>
<span class="sd">        key (str): Key of the field</span>
<span class="sd">        default (optional): Default value. Defaults to MISSING.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">_record_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">MISSING</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_record"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.set_record">[docs]</a><span class="k">def</span> <span class="nf">set_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Record</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the record for a field in a modelclass.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: The modelclass</span>
<span class="sd">        key (str): Key of the field</span>
<span class="sd">        value (record): The value to set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_record_key</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">RecordWrap</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Target</span><span class="p">,</span> <span class="n">preload</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pre</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">pre</span>

    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Record</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">Record</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rec</span><span class="o">.</span><span class="n">content</span>
        <span class="k">return</span> <span class="n">rec</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Record</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="c1"># change content of existing record</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">Record</span><span class="p">):</span>
                <span class="c1"># store old content for removal if needed</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="n">is_removable</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
                    <span class="n">unused_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

                <span class="c1"># update content</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">return</span>
            
            <span class="c1"># create new record</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">record_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">public_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">record_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="n">rec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># store old record for removal</span>
                <span class="n">unused_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">record_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">public_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># TODO add __del__ method</span>


<span class="k">class</span> <span class="nc">SerializeWrap</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">pre</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<div class="viewcode-block" id="record_fields"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.record_fields">[docs]</a><span class="k">def</span> <span class="nf">record_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all the records associated with storable fields in a modelclass.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">RECORD_FIELDS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">RECORD_FIELDS</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="unused_fields"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.unused_fields">[docs]</a><span class="k">def</span> <span class="nf">unused_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get all the records that are no longer used since they were overwritten.&quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">UNUSED_FIELDS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">UNUSED_FIELDS</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="serializefield"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.serializefield">[docs]</a><span class="k">def</span> <span class="nf">serializefield</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="n">MISSING</span><span class="p">,</span>
    <span class="n">default_factory</span><span class="o">=</span><span class="n">MISSING</span><span class="p">,</span>
    <span class="n">init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="nb">repr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="nb">hash</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compare</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pre</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Field</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an object to identify serializable modelclass fields.</span>
<span class="sd">        All arguments of the ``field`` method from ``dataclasses`` are provided.</span>
<span class="sd">        Moreover, ``record`` specific options are provided</span>

<span class="sd">    Args:</span>
<span class="sd">        default (optional): is the default value of the field.</span>
<span class="sd">        default_factory (optional): is a 0-argument function called to initialize.</span>
<span class="sd">        init (bool, optional): Include in the class&#39;s __init__(). Defaults to True.</span>
<span class="sd">        repr (bool, optional): Include in the object&#39;s repr(). Defaults to True.</span>
<span class="sd">        hash (bool, optional): Include in the object&#39;s hash(). Defaults to False.</span>
<span class="sd">        compare (bool, optional): Include in comparison functions. Defaults to True.</span>
<span class="sd">        metadata (_type_, optional): Additional information. Defaults to None.</span>
<span class="sd">        pre (Callable[[Any], Any], optional): Call method on field before setting. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>   
    <span class="n">_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__ser_field&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;__base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
    <span class="k">if</span> <span class="n">pre</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">field</span><span class="p">(</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">default_factory</span><span class="o">=</span><span class="n">default_factory</span><span class="p">,</span>
            <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
            <span class="nb">repr</span><span class="o">=</span><span class="nb">repr</span><span class="p">,</span>
            <span class="nb">hash</span><span class="o">=</span><span class="nb">hash</span><span class="p">,</span>
            <span class="n">compare</span><span class="o">=</span><span class="n">compare</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">_metadata</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="n">SerializeWrap</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapfield</span><span class="p">(</span>
            <span class="n">wrap</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
            <span class="n">default_factory</span><span class="o">=</span><span class="n">default_factory</span><span class="p">,</span>
            <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
            <span class="nb">repr</span><span class="o">=</span><span class="nb">repr</span><span class="p">,</span>
            <span class="nb">hash</span><span class="o">=</span><span class="nb">hash</span><span class="p">,</span>
            <span class="n">compare</span><span class="o">=</span><span class="n">compare</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">_metadata</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="is_serializable_field"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.is_serializable_field">[docs]</a><span class="k">def</span> <span class="nf">is_serializable_field</span><span class="p">(</span><span class="n">fld</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a field is explicitly registered as a serializable field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">fld</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fld</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__ser_field&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="recordfield"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.recordfield">[docs]</a><span class="k">def</span> <span class="nf">recordfield</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="n">MISSING</span><span class="p">,</span>
    <span class="n">default_factory</span><span class="o">=</span><span class="n">MISSING</span><span class="p">,</span>
    <span class="n">init</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="nb">repr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="nb">hash</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compare</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
    <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
    <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
    <span class="n">preload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">pre</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Field</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an object to identify storable modelclass fields.</span>
<span class="sd">        All arguments of the ``field`` method from ``dataclasses`` are provided.</span>
<span class="sd">        Moreover, ``record`` specific options are provided</span>

<span class="sd">    Args:</span>
<span class="sd">        default (optional): The default value of the field.. Defaults to MISSING.</span>
<span class="sd">        default_factory (optional): A 0-argument function called to initialize. Defaults to MISSING.</span>
<span class="sd">        init (bool, optional): Include in the class&#39;s __init__(). Defaults to True.</span>
<span class="sd">        repr (bool, optional): Include in the object&#39;s repr(). Defaults to False.</span>
<span class="sd">        hash (bool, optional): Include in the object&#39;s hash(). Defaults to False.</span>
<span class="sd">        compare (bool, optional): Include in comparison functions. Defaults to False.</span>
<span class="sd">        metadata (_type_, optional): Additional information. Defaults to None.</span>

<span class="sd">        stem (str, optional): The stem of the file. Defaults to AUTO.</span>
<span class="sd">        suffix (str, optional): The suffix or extension of the file (e.g. ``&#39;.json&#39;``). Defaults to AUTO.</span>
<span class="sd">        name (str, optional): The full name of the file. Defaults to AUTO.</span>
<span class="sd">        subdir (os.PathLike, optional): The subdirectory in which to store te file. Defaults to AUTO.</span>
<span class="sd">        preload (str, optional): When ``True`` the file will be loaded during deserialization. Defaults to False.</span>
<span class="sd">        pre (Callable[[Any], Any], optional): Call method on field before setting. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrap</span> <span class="o">=</span> <span class="n">RecordWrap</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="n">Target</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">),</span> <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">pre</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapfield</span><span class="p">(</span>
        <span class="n">wrap</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">default_factory</span><span class="p">,</span>
        <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="nb">repr</span><span class="p">,</span>
        <span class="nb">hash</span><span class="o">=</span><span class="nb">hash</span><span class="p">,</span>
        <span class="n">compare</span><span class="o">=</span><span class="n">compare</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="n">__pre_fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>


<div class="viewcode-block" id="register_preset"><a class="viewcode-back" href="../../../gallery/fundamentals/example3_models.html#dman.model.modelclasses.register_preset">[docs]</a><span class="k">def</span> <span class="nf">register_preset</span><span class="p">(</span><span class="n">tp</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">pre</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a preset method ``pre`` for a type ``tp``. </span>

<span class="sd">        When a field with that type is defined in a modelclass, ``pre`` </span>
<span class="sd">        is called before setting the field.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; register_preset(barray, lambda arg: </span>
<span class="sd">        &gt;&gt;&gt;    arg.view(barray) if isinstance(arg, np.ndarray) else arg</span>
<span class="sd">        &gt;&gt;&gt; )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__pre_fields</span><span class="p">[</span><span class="n">tp</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre</span></div>


<span class="k">def</span> <span class="nf">get_preset</span><span class="p">(</span><span class="n">tp</span><span class="p">:</span> <span class="n">Type</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">__pre_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="modelclass"><a class="viewcode-back" href="../../../gallery/fundamentals/example3_models.html#dman.model.modelclasses.modelclass">[docs]</a><span class="nd">@dataclass_transform</span><span class="p">(</span><span class="n">field_specifiers</span><span class="o">=</span><span class="p">(</span><span class="n">wrapfield</span><span class="p">,</span> <span class="n">recordfield</span><span class="p">,</span> <span class="n">serializefield</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">Field</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">modelclass</span><span class="p">(</span>
    <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">eq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">unsafe_hash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">storable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">compact</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">store_by_field</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">cluster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">template</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a class to a modelclass.</span>

<span class="sd">        Returns the same class as was passed in, with dunder methods added based </span>
<span class="sd">        on the fields defined in the class. The class is automatically made </span>
<span class="sd">        ``serializable`` by adding ``__serialize__`` and ``__deserialize__``.</span>

<span class="sd">        If an attribute ``__no_serialize__`` is added, then the</span>
<span class="sd">        field names listed as string within will not be included </span>
<span class="sd">        in the serialization.</span>

<span class="sd">        The arguments of the ``dataclass`` decorator are provided and some</span>
<span class="sd">        additional arguments are also available.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls: Class to convert.</span>
<span class="sd">        name (str, optional): Name of the serializable (and storable if required). Defaults to class name.</span>

<span class="sd">        init (bool, optional): Add an ``__init__`` method. Defaults to True.</span>
<span class="sd">        repr (bool, optional): Add a ``__repr__`` method. Defaults to True.</span>
<span class="sd">        eq (bool, optional): Add a ``__eq__`` method. Defaults to True.</span>
<span class="sd">        order (bool, optional): Add rich comparison methods. Defaults to False.</span>
<span class="sd">        unsafe_hash (bool, optional): Add a ``__hash__`` method. Defaults to False.</span>
<span class="sd">        frozen (bool, optional): Fields may not be assigned after instance creation. Defaults to False.</span>

<span class="sd">        storable (bool, optional): Make the class storable with a ``__write__`` and ``__read__``. Defaults to False.</span>
<span class="sd">        compact (bool, optional): Do not include serializable types during serialization, making the result more compact. Defaults to False.</span>
<span class="sd">        store_by_field (bool, optional): The stem of files is determined by the field name. Defaults to False.</span>
<span class="sd">        cluster (bool, optional): Each file is stored in a subfolder determined by the field name. Defaults to False.</span>
<span class="sd">        subdir (str, optional): Store the files in a common subfolder. Defaults to &quot;&quot;.</span>
<span class="sd">        template (Any, optional): Template for serialization. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_process__modelclass</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">init</span><span class="p">,</span>
            <span class="nb">repr</span><span class="p">,</span>
            <span class="n">eq</span><span class="p">,</span>
            <span class="n">order</span><span class="p">,</span>
            <span class="n">unsafe_hash</span><span class="p">,</span>
            <span class="n">frozen</span><span class="p">,</span>
            <span class="n">storable</span><span class="p">,</span>
            <span class="n">compact</span><span class="p">,</span>
            <span class="n">store_by_field</span><span class="p">,</span>
            <span class="n">cluster</span><span class="p">,</span>
            <span class="n">subdir</span><span class="p">,</span>
            <span class="n">template</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">wrap</span> <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">wrap</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_modelclass"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.is_modelclass">[docs]</a><span class="k">def</span> <span class="nf">is_modelclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a class is a modelclass.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">MODELCLASS</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_process__modelclass</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">name</span><span class="p">,</span>
    <span class="n">init</span><span class="p">,</span>
    <span class="nb">repr</span><span class="p">,</span>
    <span class="n">eq</span><span class="p">,</span>
    <span class="n">order</span><span class="p">,</span>
    <span class="n">unsafe_hash</span><span class="p">,</span>
    <span class="n">frozen</span><span class="p">,</span>
    <span class="n">as_storable</span><span class="p">,</span>
    <span class="n">compact</span><span class="p">,</span>
    <span class="n">store_by_field</span><span class="p">,</span>
    <span class="n">cluster</span><span class="p">,</span>
    <span class="n">subdir</span><span class="p">,</span>
    <span class="n">template</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># convert to dataclass</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">dataclass</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="nb">repr</span><span class="p">,</span>
        <span class="n">eq</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
        <span class="n">unsafe_hash</span><span class="o">=</span><span class="n">unsafe_hash</span><span class="p">,</span>
        <span class="n">frozen</span><span class="o">=</span><span class="n">frozen</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># auto convert fields if necessary</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="n">get_preset</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_wrapfield</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="n">get_descriptor</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="p">(</span><span class="n">RecordWrap</span><span class="p">,</span> <span class="n">SerializeWrap</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">descr</span><span class="o">.</span><span class="n">pre</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">descr</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">pre</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="n">RecordWrap</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">store_by_field</span> <span class="ow">and</span> <span class="n">descr</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">stem</span> <span class="ow">is</span> <span class="n">AUTO</span><span class="p">:</span>
                    <span class="n">descr</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">stem</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">descr</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">subdir</span> <span class="ow">is</span> <span class="n">AUTO</span><span class="p">:</span>
                    <span class="n">descr</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">cluster</span> <span class="k">else</span> <span class="n">subdir</span>
        <span class="k">elif</span> <span class="n">is_serializable_field</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">ser_field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">serializefield</span><span class="p">(</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__base&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">pre</span><span class="o">=</span><span class="n">pre</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">ser_field</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">elif</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
            <span class="n">wrapped_field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">recordfield</span><span class="p">(</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span>
                <span class="n">stem</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">store_by_field</span> <span class="k">else</span> <span class="n">AUTO</span><span class="p">,</span>
                <span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">cluster</span> <span class="k">else</span> <span class="n">subdir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">wrapped_field</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">elif</span> <span class="n">pre</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ser_field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">serializefield</span><span class="p">(</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__base&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">pre</span><span class="o">=</span><span class="n">pre</span>
            <span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">ser_field</span><span class="o">.</span><span class="n">metadata</span>

    <span class="c1"># wrap the fields</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">wrappedclass</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># set modelclass flag</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">MODELCLASS</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># assign remove method if not pre-defined</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">REMOVE</span><span class="p">,</span> <span class="n">_remove__modelclass</span><span class="p">)</span>

    <span class="c1"># assign serialize and deserialize methods</span>
    <span class="k">if</span> <span class="n">template</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">serializable</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ser</span><span class="p">,</span> <span class="n">dser</span> <span class="o">=</span> <span class="n">_serialize__modelclass</span><span class="p">,</span> <span class="n">_deserialize__modelclass</span>
        <span class="k">if</span> <span class="n">compact</span><span class="p">:</span>
            <span class="n">ser</span><span class="p">,</span> <span class="n">dser</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_serialize__modelclass_content_only</span><span class="p">,</span>
                <span class="n">_deserialize__modelclass_content_only</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">SERIALIZE</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">SERIALIZE</span><span class="p">,</span> <span class="n">ser</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">DESERIALIZE</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">DESERIALIZE</span><span class="p">,</span> <span class="n">dser</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">serializable</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">as_storable</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">storable</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_remove__modelclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">BaseContext</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unused_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="n">_rfields</span> <span class="o">=</span> <span class="n">record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NO_SERIALIZE</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;removing field: &quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;modelclass&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_rfields</span><span class="p">:</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">_rfields</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_serialize__modelclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;serializing modelclass with fields </span><span class="si">{</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;modelclass&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># remove unused fields   </span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span><span class="p">:</span>        
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unused_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># serialize used fields</span>
    <span class="n">_rfields</span> <span class="o">=</span> <span class="n">record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NO_SERIALIZE</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_rfields</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">_rfields</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;serializing </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> of type: &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;modelclass&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">_deserialize__modelclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;deserializing field: &quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; of type: &quot;</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;__name__&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">))</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="s2">&quot;modelclass&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">processed</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">MISSING</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="n">MISSING</span><span class="p">:</span>
            <span class="n">processed</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">processed</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_serialize__modelclass_content_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">BaseContext</span><span class="p">()</span>

    <span class="c1"># remove unused fields </span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span><span class="p">:</span>         
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unused_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="c1"># serialize the rest</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">_rfields</span> <span class="o">=</span> <span class="n">record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NO_SERIALIZE</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_rfields</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">_rfields</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;serializing field: &quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;modelclass&quot;</span><span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">content_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>


<span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">_deserialize__modelclass_content_only</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">_rfields</span> <span class="o">=</span> <span class="n">record_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">MISSING</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="n">MISSING</span><span class="p">:</span>
                <span class="n">processed</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;deserializing field: &quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;modelclass&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_rfields</span><span class="p">:</span>
            <span class="n">processed</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">Record</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">processed</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">processed</span><span class="p">)</span>


<div class="viewcode-block" id="is_model"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.is_model">[docs]</a><span class="k">def</span> <span class="nf">is_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the provided class is a model type.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="p">(</span><span class="n">_blist</span><span class="p">,</span> <span class="n">_bdict</span><span class="p">,</span> <span class="n">_bruns</span><span class="p">))</span>
        <span class="ow">or</span> <span class="n">is_modelclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Record</span><span class="p">)</span>
    <span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_blist</span><span class="p">(</span><span class="n">MutableSequence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base Type for Model Lists.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iterable</span><span class="p">:</span> <span class="n">Iterable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of this model list.</span>

<span class="sd">        :param iterable: Initial content of the list.</span>
<span class="sd">        :param str subdir: Specify the default sub-subdirectory for storables.</span>
<span class="sd">        :param bool preload: Specify whether storables should be preloaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdir</span> <span class="o">=</span> <span class="n">subdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>

        <span class="k">if</span> <span class="n">iterable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">itm</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unused</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">Record</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_content</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_blist</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__make_record__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itm</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">record</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subdir</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__serialize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="n">lst</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;subdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;preload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removing unused items ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="p">:</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unused</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;serializing store ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">itm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;serializing index: &quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; of type: &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot; ...&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">Record</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">or</span> <span class="n">itm</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serialize</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">serialize</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;clean dangling pointers ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="p">:</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unused</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__deserialize__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subdir&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">preload</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preload&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">lst</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">())</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deserializing list ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">itm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;deserializing index: &quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot; of type: &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot; ...&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deserialize</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">stem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">preload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a storable into this list.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: The value to store.</span>
<span class="sd">            idx (int, optional): The index at which to store it (if not specified, the value is appended). Defaults to None.</span>
<span class="sd">            stem (str, optional): The stem of a file. Defaults to AUTO.</span>
<span class="sd">            suffix (str, optional): The suffix or extension of the file (e.g. ``&#39;.json&#39;``). Defaults to AUTO.</span>
<span class="sd">            name (str, optional): The full name of the file. Defaults to AUTO.</span>
<span class="sd">            subdir (os.PathLike, optional): The subdirectory in which to store te file. Defaults to &quot;&quot;.</span>
<span class="sd">            preload (str, optional): When ``True`` the file will be loaded during deserialization. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">rec</span><span class="p">:</span> <span class="n">Record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span>
                <span class="n">stem</span><span class="o">=</span><span class="n">stem</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">subdir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>

    <span class="k">def</span> <span class="nf">__remove__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removing items ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">itm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">Record</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">itm</span><span class="o">.</span><span class="n">content</span>
        <span class="k">return</span> <span class="n">itm</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">():</span>
            <span class="n">itm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">Record</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="n">is_removable</span><span class="p">(</span><span class="n">itm</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">itm</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">itm</span>
            <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="n">is_removable</span><span class="p">(</span><span class="n">itm</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_record__</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_record__</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">itm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="n">is_removable</span><span class="p">(</span><span class="n">itm</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">itm</span><span class="o">.</span><span class="n">content</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">Record</span><span class="p">)</span> <span class="k">else</span> <span class="n">itm</span> <span class="k">for</span> <span class="n">itm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>


<div class="viewcode-block" id="mlist"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.mlist">[docs]</a><span class="nd">@serializable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_ser__mlist&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">mlist</span><span class="p">(</span><span class="n">_blist</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serializable Model List.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="smlist"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.smlist">[docs]</a><span class="nd">@storable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_sto__mlist&quot;</span><span class="p">)</span>
<span class="nd">@serializable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_ser__smlist&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">smlist</span><span class="p">(</span><span class="n">mlist</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storable Model List.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">_bdict</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base type for Model Dictionaries&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">store_by_key</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">store_subdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of this model dictionary.</span>

<span class="sd">        :param str subdir: Specify the default sub-subdirectory for storables.</span>
<span class="sd">        :param bool preload: Specify whether storables should be preloaded.</span>
<span class="sd">        :param bool store_by_key: Sets the stem to the key in the dictionary.</span>
<span class="sd">        :param bool store_subdir: Stores files in dedicated subdir based on key.</span>
<span class="sd">        :param kwargs: Initial content of the dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdir</span> <span class="o">=</span> <span class="n">subdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_store_by_key</span> <span class="o">=</span> <span class="n">store_by_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_subdir</span> <span class="o">=</span> <span class="n">store_subdir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unused</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">store_by_key</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">store_subdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span>
            <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">,</span>
            <span class="n">store_by_key</span><span class="o">=</span><span class="n">store_by_key</span><span class="p">,</span>
            <span class="n">store_subdir</span><span class="o">=</span><span class="n">store_subdir</span>
        <span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">store_by_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_by_key</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_subdir</span> <span class="o">=</span> <span class="n">subdir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Target</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subdir</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">Record</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_content</span>
            <span class="n">dct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_bdict</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__serialize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="n">dct</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;subdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;preload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_by_key</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;store_by_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_by_key</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_subdir</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;store_subdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_subdir</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removing unused items ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="p">:</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unused</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;serializing store ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">itm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;serializing at key: &quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&quot; of type: &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot; ...&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">Record</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">or</span> <span class="n">itm</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">dct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;clean dangling pointers ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="p">:</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unused</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__deserialize__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
        <span class="n">dct</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">subdir</span><span class="o">=</span><span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subdir&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">preload</span><span class="o">=</span><span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preload&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">store_by_key</span><span class="o">=</span><span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;store_by_key&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">store_subdir</span><span class="o">=</span><span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;store_subdir&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deserializing dict ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;deserializing at key: &quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&quot; of type: &quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&quot; ...&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">__make_record__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">key_config</span> <span class="o">=</span> <span class="n">Target</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_by_key</span><span class="p">:</span>
            <span class="n">key_config</span> <span class="o">=</span> <span class="n">key_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stem</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_subdir</span><span class="p">:</span>
            <span class="n">key_config</span> <span class="o">=</span> <span class="n">key_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdir</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">key_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Record</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__remove__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removing items ...&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">remove</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">itm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">Record</span><span class="p">):</span>
            <span class="n">itm</span> <span class="o">=</span> <span class="n">itm</span><span class="o">.</span><span class="n">content</span>
            <span class="k">return</span> <span class="n">itm</span>
        <span class="k">return</span> <span class="n">itm</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">itm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">Record</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="n">is_removable</span><span class="p">(</span><span class="n">itm</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">itm</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">itm</span>  
        <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="n">is_removable</span><span class="p">(</span><span class="n">itm</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__make_record__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">,</span>
        <span class="n">value</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">stem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">preload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a storable into this dict.</span>

<span class="sd">        Args:</span>
<span class="sd">            key: The key at which to store the value.</span>
<span class="sd">            value: The value to store.</span>
<span class="sd">            idx (int, optional): The index at which to store it (if not specified, the value is appended). Defaults to None.</span>
<span class="sd">            stem (str, optional): The stem of a file. Defaults to AUTO.</span>
<span class="sd">            suffix (str, optional): The suffix or extension of the file (e.g. ``&#39;.json&#39;``). Defaults to AUTO.</span>
<span class="sd">            name (str, optional): The full name of the file. Defaults to AUTO.</span>
<span class="sd">            subdir (os.PathLike, optional): The subdirectory in which to store te file. Defaults to &quot;&quot;.</span>
<span class="sd">            preload (str, optional): When ``True`` the file will be loaded during deserialization. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">rec</span><span class="p">:</span> <span class="n">Record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span>
                <span class="n">stem</span><span class="o">=</span><span class="n">stem</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">subdir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">itm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">auto_clean</span> <span class="ow">and</span> <span class="n">is_removable</span><span class="p">(</span><span class="n">itm</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unused</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>


<div class="viewcode-block" id="mdict"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.mdict">[docs]</a><span class="nd">@serializable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_ser__mdict&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">mdict</span><span class="p">(</span><span class="n">_bdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serializable Model Dictionary.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="smdict"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.smdict">[docs]</a><span class="nd">@storable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_sto__smdict&quot;</span><span class="p">)</span>
<span class="nd">@serializable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_ser__smdict&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">smdict</span><span class="p">(</span><span class="n">_bdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storable Model Dictionary.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">_bruns</span><span class="p">(</span><span class="n">_blist</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base type for Runs.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">iterable</span><span class="p">:</span> <span class="n">Iterable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">store_subdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of this labeled model list.</span>

<span class="sd">        :param iterable: Initial content of the list.</span>
<span class="sd">        :param str stem: The stem used to determine file keys (e.g. stem-0, stem-1, ...).</span>
<span class="sd">        :param str subdir: Specify the default sub-subdirectory for storables.</span>
<span class="sd">        :param bool preload: Specify whether storables should be preloaded.</span>
<span class="sd">        :param bool store_subdir: Specify whether each item should be stored in a separate directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stem</span> <span class="o">=</span> <span class="n">stem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_subdir</span> <span class="o">=</span> <span class="n">store_subdir</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">iterable</span><span class="o">=</span><span class="n">iterable</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="n">preload</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Target</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subdir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__make_record__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itm</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_count</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">key_config</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span><span class="n">stem</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_subdir</span><span class="p">:</span>
            <span class="n">key_config</span> <span class="o">=</span> <span class="n">key_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">stem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdir</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key_config</span> <span class="o">=</span> <span class="n">key_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subdir</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">key_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Record</span><span class="p">(</span><span class="n">itm</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__serialize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;stem&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="s2">&quot;run_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_count</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_subdir</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s2">&quot;store_subdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__serialize__</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__deserialize__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">BaseContext</span><span class="p">):</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">_bruns</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">_bruns</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__deserialize__</span><span class="p">(</span><span class="n">serialized</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">stem</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stem&quot;</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">run_count</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;run_count&quot;</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">store_subdir</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;store_subdir&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">value</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">stem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">AUTO</span><span class="p">,</span>
        <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">preload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Record a storable into this list.</span>

<span class="sd">        :param value:           The value to store.</span>
<span class="sd">        :param int:             The index at which to store it (if not specified, the value is appended).</span>
<span class="sd">        :param str stem:        The stem of a file.</span>
<span class="sd">        :param str suffix:      The suffix or extension of the file (e.g. ``&#39;.json&#39;``).</span>
<span class="sd">        :param str name:        The full name of the file.</span>
<span class="sd">        :param str subdir:      The subdirectory in which to store te file.</span>
<span class="sd">        :param bool preload:    When ``True`` the file will be loaded during deserialization.</span>

<span class="sd">        :raises ValueError:     if a name and a stem and/or suffix are specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_storable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">rec</span><span class="p">:</span> <span class="n">Record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span>
                <span class="n">stem</span><span class="o">=</span><span class="n">stem</span><span class="p">,</span>
                <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">subdir</span><span class="p">,</span> <span class="n">subdir</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">preload</span><span class="p">:</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">preload</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_blist</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span>


<div class="viewcode-block" id="mruns"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.mruns">[docs]</a><span class="nd">@serializable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_ser__mruns&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">mruns</span><span class="p">(</span><span class="n">_bruns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serializable Model Runs.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="smruns"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.smruns">[docs]</a><span class="nd">@storable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_sto__smruns&quot;</span><span class="p">)</span>
<span class="nd">@serializable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;_ser__smruns&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">smruns</span><span class="p">(</span><span class="n">_bruns</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storable Model Runs.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="mlist_factory"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.mlist_factory">[docs]</a><span class="k">def</span> <span class="nf">mlist_factory</span><span class="p">(</span><span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for Model List. Useful in combination with modelclass fields.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">mlist</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">factory</span></div>


<div class="viewcode-block" id="smlist_factory"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.smlist_factory">[docs]</a><span class="k">def</span> <span class="nf">smlist_factory</span><span class="p">(</span><span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for Storable Model List. Useful in combination with modelclass fields.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">smlist</span><span class="p">(</span><span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">factory</span></div>


<div class="viewcode-block" id="mdict_factory"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.mdict_factory">[docs]</a><span class="k">def</span> <span class="nf">mdict_factory</span><span class="p">(</span>
    <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">store_by_key</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">store_subdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for Model Dict. Useful in combination with modelclass fields.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">mdict</span><span class="p">(</span>
            <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span>
            <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">,</span>
            <span class="n">store_by_key</span><span class="o">=</span><span class="n">store_by_key</span><span class="p">,</span>
            <span class="n">store_subdir</span><span class="o">=</span><span class="n">store_subdir</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">factory</span></div>


<div class="viewcode-block" id="smdict_factory"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.smdict_factory">[docs]</a><span class="k">def</span> <span class="nf">smdict_factory</span><span class="p">(</span>
    <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">store_by_key</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">store_subdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for Storable Model Dict. Useful in combination with modelclass fields.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">smdict</span><span class="p">(</span>
            <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span>
            <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">,</span>
            <span class="n">store_by_key</span><span class="o">=</span><span class="n">store_by_key</span><span class="p">,</span>
            <span class="n">store_subdir</span><span class="o">=</span><span class="n">store_subdir</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">factory</span></div>


<div class="viewcode-block" id="mruns_factory"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.mruns_factory">[docs]</a><span class="k">def</span> <span class="nf">mruns_factory</span><span class="p">(</span>
    <span class="n">stem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span>
    <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">store_subdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for Model Runs. Useful in combination with modelclass fields.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">mruns</span><span class="p">(</span>
            <span class="n">stem</span><span class="o">=</span><span class="n">stem</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">,</span> <span class="n">store_subdir</span><span class="o">=</span><span class="n">store_subdir</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">factory</span></div>


<div class="viewcode-block" id="smruns_factory"><a class="viewcode-back" href="../../../api/modelclasses.html#dman.model.modelclasses.smruns_factory">[docs]</a><span class="k">def</span> <span class="nf">smruns_factory</span><span class="p">(</span>
    <span class="n">stem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">subdir</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">preload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">store_subdir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for Storable Model Runs. Useful in combination with modelclass fields.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">smruns</span><span class="p">(</span>
            <span class="n">stem</span><span class="o">=</span><span class="n">stem</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">,</span> <span class="n">store_subdir</span><span class="o">=</span><span class="n">store_subdir</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">factory</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Peter Coppens.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>